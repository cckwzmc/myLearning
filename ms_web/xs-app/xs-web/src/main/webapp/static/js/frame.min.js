
$(function(){$(".cldz").click(function(){$("#readview").slideToggle();});$('#fbpl').draggable({handle:'h3'});$('#a_fbpl').click(openPinglun);$('#open_pl').click(openPinglun);$('#small_pl').click(function(){$('#fbpl').toggle('slow');});$('#title,#content').focus(function(){$(this).keyup(function(event){event.stopPropagation();});});$('#send_thread').click(function(){formThread();});function formThread(){if(!user){if(confirm("发表书评需要用户登录，确定登录吗？")){login();}
return false;}
var content=$.trim($('#content').val());var title=$.trim($('#title').val());if(content==""){alert("请输入内容");return false;}
if(title==""){alert("请输入标题");return false;}
if(title.length<3)
{alert("标题太短，请至少输入3个字符 !");return false;}
if(title.length>30)
{alert("标题太长，不能超过30个字符 !");return false;}
if(content.length>4000)
{alert("内容太长，不能超过4000个字符 !");return false;}
var pattern=new RegExp("\\[cat_\\d+\\]|\\[dragon_\\d+\\]","g");var matcher=content.match(pattern);var result=content.replace(pattern,"");if(result=="")
{alert("留言不能都是表情 !");return false;}
if(matcher!=null&&matcher.length!=null&&matcher.length>5)
{alert("表情最多不能超过5个 !");return false;}
var url="/ajax/book.commend.addThread.do";var bookId=$('body').attr("bookId");var params={bookId:bookId,title:title,content:content};$.ajax({type:"POST",url:url,data:params,success:function(data){if(data){if(data.mes){alert(data.mes);}
if(data.ret){alert("发表书评成功 !");if(window.closeDialog!=null)
{window.closeDialog("fbpl");}
jQuery("#Loadert").css("visibility","visible");if(window.showFlashReader!=null)
{window.showFlashReader();}}}},dataType:'json',async:false});return false;}
$('#rbticket').draggable();$('#open_tj').click(openTuijian);$('#close_tj').click(function(){$('#rbticket').toggle('slow');$('#a_tpfj').remove();});$('#small_tj').click(function(){$('#rbticket').toggle('slow');});$('.voteRecommend').click(function(){if(user){var url='/ajax/book.recommend.do';var bookId=$('body').attr("bookId");var tp=$(this).attr("tp");var params={bookId:bookId,tp:tp};$.ajax({type:"POST",url:url,data:params,success:function(data){if(data){if(data.mes){alert(data.mes);}
if(data.ret){if(tp==0){$('#red').html(parseInt($('#red').html())+1);}else if(tp==1){$('#black').html(parseInt($('#black').html())+1);}
$('#userVote').html(data.leftRecomment);}}},dataType:'json',async:false});}else{if(confirm('只有登录用户才能投票,确定要登录吗?')){login();}}});var ratio=$('#pingjia').attr("ratio");$('#pingjia').css("width",ratio+"%");$('#tuck').draggable();$('#open_sj').click(function(){var size=$('#a_sj').size();if(size==0){var console_pl=$('<a id="a_sj"></a>');console_pl.click(function(){$('#tuck').toggle('slow');});console_pl.append("<span>加入书架</span>");$('#console_list').append(console_pl);}
$('#tuck').toggle('slow');});$('#close_sj').click(function(){$('#tuck').toggle('slow');$('#a_sj').remove();});$('.small_sj').click(function(){$('#tuck').toggle('slow');});$('#add_shelf').click(function(){if(user){var url='/ajax/bookshelf.do';var bookId=$('body').attr("bookId");$.ajax({type:"POST",url:url,data:{bookId:bookId},success:function(data){if(data){if(data.mes){alert(data.mes);}}},dataType:'json',async:false});}else{if(confirm('只有登录用户才能使用书架,确定要登录吗?')){login();}}});$('#authortp').draggable();$('#open_dc').click(function(){var size=$('#a_zzdc').size();if(size==0){var console_pl=$('<a id="a_zzdc"></a>');console_pl.click(function(){$('#authortp').toggle('slow');});console_pl.append("<span>作者调查</span>");$('#console_list').append(console_pl);}
$('#authortp').toggle('slow');});$('#close_dc').click(function(){$('#authortp').toggle('slow');$('#a_zzdc').remove();});$('#small_dc').click(function(){$('#authortp').toggle('slow');});$('#submit_vote').click(function(){if(!user){if(confirm("注册用户才可以投票，确定登录吗？")){login();return;}else{return;}}
var bookId=$('body').attr("bookId");var topicId=$(this).attr("topicId");var single=$(this).attr("sg");var val;if(single==="1"){val=$('input:radio[name=option_check]:checked').val();if(val==undefined||val==""){alert("请选择后投票");return;}}else{val=new Array();$('input:checkbox[name=option_check]:checked').each(function(index,obj){val[index]=$(obj).val();});if(val.length==0){alert("请选择后投票");return;}}
var params={bookId:bookId,topicId:topicId,single:single,val:val};var url='/ajax/book.addvote.do';$.ajax({type:"POST",url:url,data:params,success:function(data){if(data){if(data.mes){alert(data.mes);}
if(data.ret){alert("投票成功,感谢您的支持");}}},dataType:'json',async:false});return false;});if(user){$.PopPanel({from:"#userInfoBtn",to:"#userinfo"});}else{$.PopPanel({from:"#userLogin",to:"#login-block",close:"#userLoginCloseBtn"});}
$('.reg').click(function(){location.href="http://passport.zongheng.com/reg.do?location="+encodeURIComponent(location.href);});$('.logout').click(function(){logout();});jQuery(".readAll").each(function(){var bookId=jQuery("body").attr("bookId");jQuery(this).attr("href","http://book.zongheng.com/totaltome/"+bookId+".html");});jQuery(".readPart").each(function(){var bookId=jQuery("body").attr("bookId");var tomeId=jQuery(this).attr("tomeId");jQuery(this).attr("href","http://book.zongheng.com/parttome/"+bookId+"/"+tomeId+".html");});jQuery(".download").click(function(){var s=(new Date()).getTime();var t=window.download_timestamp;if(t!=null&&typeof(t)=="number")
{if(s-t<=60000)
{alert("您下载的太快了，请稍后再下载 ！");return false;}}
if(user)
{window.download_timestamp=s;}
var bookId=$('body').attr("bookId");if(user){var logURL=$(this).attr('log');if(logURL){logger(logURL);}
var form=document.getElementById("temp_form");if(form==null)
{form=document.createElement("form");form.id="temp_form";form.method="get";document.body.appendChild(form);}
form.innerHTML="";form.action="http://dl.zongheng.com/book/"+bookId+".txt";form.submit();}else{if(confirm('只有登录用户才能使用全文下载,确定要登录吗?')){login();}}});if(user){$.post("/ajax/user.info.do",{},function(data){if(data.ret){try
{if(window.UserInfoManager!=null)
{window.UserInfoManager.trigger(data);}
if(window.onGetCurrentUserInfo!=null)
{window.onGetCurrentUserInfo(data);}}
catch(e)
{}
var userInfoFixed=function(userInfo)
{if(userInfo.type==null)
{userInfo.type=0;}
if(isNaN(parseInt(userInfo.type)))
{userInfo.type=0;}
if(userInfo.level==null)
{userInfo.level=1;}
if(isNaN(parseInt(userInfo.level)))
{userInfo.level=1;}
userInfo.level=parseInt(userInfo.level);if(userInfo.userLevelScore==null||isNaN(userInfo.userLevelScore))
{userInfo.userLevelScore=0;}
else
{userInfo.userLevelScore=parseInt(userInfo.userLevelScore);}
if(userInfo.nextUserLevelScore==null||isNaN(userInfo.nextUserLevelScore))
{userInfo.nextUserLevelScore=100;}
else
{userInfo.nextUserLevelScore=parseInt(userInfo.nextUserLevelScore);}
if(userInfo.userLevelScore<=0)
{userInfo.userLevelScore=0;}
if(userInfo.nextUserLevelScore<=0)
{userInfo.nextUserLevelScore=100;}
var percent=(userInfo.userLevelScore/userInfo.nextUserLevelScore);if(isNaN(percent)||percent<0)
{percent=0.0;}
if(percent>1.0)
{percent=1.0;}
userInfo.percent=percent;return userInfo;};var getUserLevelIcons=function(level)
{var icons=[];if(level!=null)
{level=parseInt(level);if(isNaN(level)==false&&level>0)
{level=(level<=21?level:21);var sun=Math.floor(level/16);var moon=Math.floor((level-sun*16)/4);var star=(level-sun*16-moon*4);icons[icons.length]="<span class=\"leval\" title=\"用户等级："+level+"级\">";for(var i=0;i<sun;i++)
{icons[icons.length]="<span class=\"level_sun\"></span>";}
for(var i=0;i<moon;i++)
{icons[icons.length]="<span class=\"level_moon\"></span>";}
for(var i=0;i<star;i++)
{icons[icons.length]="<span class=\"level_star\"></span>";}
icons[icons.length]="</span>";}}
return icons.join("");};data=userInfoFixed(data);var obj=$('#userinfo');var userImage=$('<a href="http://home.zongheng.com" title="头像" class="userimg"></a>');userImage.append($('<img width="100" height="100"></img>').attr("src",data.image));obj.append(userImage);var div=$('<div class="right"></div>');if(data.type==1)
{div.append($("<h2><a href=\"http://home.zongheng.com\" class=\"f33\">"+user.nickName+"</a><span title=\"VIP1级用户\" class=\"level_vip1 va_b\"></span></h2>"));}
else if(data.type==2)
{div.append($("<h2><a href=\"http://home.zongheng.com\" class=\"f33\">"+user.nickName+"</a><span title=\"VIP2级用户\" class=\"level_vip2 va_b\"></span></h2>"));}
else if(data.type==3)
{div.append($("<h2><a href=\"http://home.zongheng.com\" class=\"f33\">"+user.nickName+"</a><span title=\"VIP3级用户\" class=\"level_vip3 va_b\"></span></h2>"));}
else if(data.type==4)
{div.append($("<h2><a href=\"http://home.zongheng.com\" class=\"f33\">"+user.nickName+"</a><span title=\"VIP4级用户\" class=\"level_vip4 va_b\"></span></h2>"));}
else if(data.type==5)
{div.append($("<h2><a href=\"http://home.zongheng.com\" class=\"f33\">"+user.nickName+"</a><span title=\"VIP5级用户\" class=\"level_vip5 va_b\"></span></h2>"));}
div.append($('<div class="spline"></div>'));div.append(jQuery("<p>头衔：<span>"+data.level_title+"<\/span>"+getUserLevelIcons(data.level)+"<\/p>"));var width=Math.floor(data.percent*160);div.append(jQuery("<div class=\"dj\"><span class=\"all\" title=\""+data.userLevelScore+"/"+(data.userLevelScore<data.nextUserLevelScore?data.nextUserLevelScore:"无")+"\"><span class=\"now\" style=\"width: "+width+"px\"></span></span>"+Math.floor(data.percent*100)+"%</div>"));div.append(jQuery("<p>推荐票：<span>"+data.recomment+"</span></p>"));div.append($('<p>纵横币：<span class="qian">'+data.money+'<em>&nbsp;</em></span><a href="http://home.zongheng.com/show/charge.html" class="forg">[充值]</a></p>'));obj.append(div);$('#userMsg').html(data.message);$('#userVote').html(data.recomment);$('#open_msg').html("·短消息("+data.message+")");}},"json");}
$('.jrsq').click(function(){var params={bookId:$('body').attr("bookId"),chapterId:$('body').attr("chapterId"),tomeId:$('body').attr("tomeId")};if(user){$.getJSON("/ajax/book.bookmark.do",params,function(data){if(data.mes){alert(data.mes);}});}else{if(confirm('只有登录用户才能使用书签功能,确定要登录吗?')){login();}}});$('.listenRead').mouseover(function(){var tomeId=$(this).attr('tomeId');var chapterId=$(this).attr('chapterId');$('body').attr('tomeId',tomeId);$('body').attr('chapterId',chapterId);});$('#open_msg').click(function(){if(user){document.location="http://home.zongheng.com/msgIn.do";}else{if(confirm('只有登录用户才能使用短消息功能,确定要登录吗?')){login("http://home.zongheng.com/msgIn.do");}}});$('#default_view').click(function(){defaultView();$.cookie("rv",'defaultView',{path:"/",domain:".book.zongheng.com",expires:365});});$('#pink_view').click(function(){pinkView();$.cookie("rv",'pinkView',{path:"/",domain:".book.zongheng.com",expires:365});});$('#green_view').click(function(){greenView();$.cookie("rv",'greenView',{path:"/",domain:".book.zongheng.com",expires:365});});$('#vista_view').click(function(){vistaView();$.cookie("rv",'vistaView',{path:"/",domain:".book.zongheng.com",expires:365});});$('#user_view').click(function(){userView();$.cookie("rv",'userView',{path:"/",domain:".book.zongheng.com",expires:365});});$('#style_bg_color').change(function(){var bgColor=$("#style_bg_color option:selected").val();$('body').css('background',bgColor);});$('#style_font').change(function(){var stFont=$("#style_font option:selected").val();$('#readtext p').css('font-family',stFont);});$('#style_ft_color').change(function(){var ftColor=$("#style_ft_color option:selected").val();$('#readtext p').css('color',ftColor);});$('#style_font_size').change(function(){var ftSize=$("#style_font_size option:selected").val();$('#readtext p').css('font-size',ftSize);});$('#style_margin').change(function(){var stMargin=$("#style_margin option:selected").val();$('#readcon').css('margin',stMargin);});$('#style_line_height').change(function(){var stLineHeight=$("#style_line_height option:selected").val();$('#readtext p').css('line-height',stLineHeight);});$('#save_user_view').click(function(){var bgColor=$("#style_bg_color option:selected").val();var stFont=$("#style_font option:selected").val();var ftColor=$("#style_ft_color option:selected").val();var ftSize=$("#style_font_size option:selected").val();var stMargin=$("#style_margin option:selected").val();var stLineHeight=$("#style_line_height option:selected").val();$.cookie("uv",'userView',{path:"/",domain:".book.zongheng.com",expires:365});$.cookie("rv",'userView',{path:"/",domain:".book.zongheng.com",expires:365});$.cookie("style_bg_color",bgColor,{path:"/",domain:".book.zongheng.com",expires:365});$.cookie("style_font",stFont,{path:"/",domain:".book.zongheng.com",expires:365});$.cookie("style_ft_color",ftColor,{path:"/",domain:".book.zongheng.com",expires:365});$.cookie("style_font_size",ftSize,{path:"/",domain:".book.zongheng.com",expires:365});$.cookie("style_margin",stMargin,{path:"/",domain:".book.zongheng.com",expires:365});$.cookie("style_line_height",stLineHeight,{path:"/",domain:".book.zongheng.com",expires:365});alert("保存自定义策略成功");});readView();if($.browser.mozilla)
{$(document).keydown(function(event){if(event.keyCode==32||event.keyCode==34)
{event.preventDefault();var wHeight=$(window).height();var scrollTop=$(document).scrollTop();var span=jQuery("span.close").get(0);if(span!=null&&span.className!=null&&span.className.indexOf("open")>-1&&span.className.indexOf("close")>-1)
{$(document).scrollTop(wHeight+scrollTop-30);}
else
{$(document).scrollTop(wHeight+scrollTop-60);}
return false;}
else if(event.keyCode==33)
{event.preventDefault();var wHeight=$(window).height();var scrollTop=$(document).scrollTop();$(document).scrollTop(scrollTop-wHeight+60);return false;}});}});function openTuijian(){var size=$('#a_tpfj').size();if(size==0){var console_pl=$('<a id="a_tpfj"></a>');console_pl.click(function(){$('#rbticket').toggle('slow');});console_pl.append("<span>投票推荐</span>");$('#console_list').append(console_pl);}
$('#rbticket').toggle('slow');}
function openPinglun(){$('#fbpl').toggle('slow');}
function defaultView(){$('body').css('background','#E9FAFF');var cssObj={'color':'#454545','line-height':'1.8em','font-family':'宋体','font-size':'14px'};$('#readtext p').css(cssObj);$('#readcon').css('margin','0 10%');$('#headSlected').html('默认策略');}
function pinkView(){$('body').css('background','#ffeff5');var cssObj={'color':'#a30355','line-height':'1.8em','font-family':'宋体','font-size':'14px'};$('#readtext p').css(cssObj);$('#readcon').css('margin','0 10%');$('#headSlected').html('粉色言情');}
function greenView(){$('body').css('background','#eefaee');var cssObj={'color':'#00471e','line-height':'1.8em','font-family':'宋体','font-size':'14px'};$('#readtext p').css(cssObj);$('#readcon').css('margin','0 10%');$('#headSlected').html('绿色健康');}
function vistaView(){$('body').css('background','#E9FAFF');var cssObj={'color':'#454545','line-height':'1.8em','font-family':'微软雅黑','font-size':'14px'};$('#readtext p').css(cssObj);$('#readcon').css('margin','0 20%');$('#headSlected').html('Vista宽屏');}
function userView(){var view=$.cookie('uv');if(view!=null&&view=='userView'){var bgColor=$.cookie('style_bg_color');if(bgColor!=null){$('body').css('background',bgColor);}
var stFont=$.cookie('style_font');if(stFont!=null){$('#readtext p').css('font-family',stFont);}
var ftColor=$.cookie('style_ft_color');if(ftColor!=null){$('#readtext p').css('color',ftColor);}
var ftSize=$.cookie('style_font_size');if(ftSize!=null){$('#readtext p').css('font-size',ftSize);}
var stMargin=$.cookie('style_margin');if(stMargin!=null){$('#readcon').css('margin',stMargin);}
var stLineHeight=$.cookie('style_line_height');if(stLineHeight!=null){$('#readtext p').css('line-height',stLineHeight);}
$('#headSlected').html('自定义策略');}}
function readView(){var readView=$.cookie('rv');if(readView!=null){switch(readView){case'defaultView':{defaultView();break;}
case'pinkView':{pinkView();break;}
case'greenView':{greenView();break;}
case'vistaView':{vistaView();break;}
case'userView':{userView();break;}
default:{defaultView();}}}}
$(function(){$('a[rel=tooltip]').mouseover(function(e){var t=$(this).attr('title');$(this).attr('title','');if($.browser.msie&&$.browser.version=='6.0'){$(this).append('<div id="tooltip" class=tooltip>'+t+'</div>');$("#tooltip").css("margin-top",+12+"px");}else{$(this).append('<div id="tooltip" class=tooltip>'+t+'</div>');$("#tooltip").css("top",(e.pageY+12)+"px");}
$('#tooltip').css('left',e.pageX+10);}).mousemove(function(e){if($.browser.msie&&$.browser.version=='6.0'){$("#tooltip").css("margin-top",+12+"px");}else{$("#tooltip").css("top",(e.pageY+12)+"px");}
$('#tooltip').css('left',e.pageX+10);}).mouseout(function(){$(this).attr('title',$('.tooltip').html());$(this).children('div#tooltip').remove();});$("span.close").click(function()
{var mc=$.cookie("mc");if(mc==null||mc==="true")
{$.cookie("mc","false",{path:"/",domain:".zongheng.com"});}
else
{$.cookie("mc","true",{path:"/",domain:".zongheng.com"});}
menuClose.call(this);});var mc=$.cookie("mc");if(mc==null||mc==="true")
{menuClose.call($("span.close").get(0));}});function menuClose(){$("#readtop span.close").css("padding-right","0");$("#readtop .bg").css("margin-right","0");$("#readbot .bg").css("margin-right","0");$("#readtop .bg").slideToggle("normal");$(this).toggleClass("open");$(this).toggleClass("active");$("#readbot").slideToggle("normal");}
var timeout=500;var closetimer=0;var ddmenuitem=0;function jsddm_open()
{jsddm_canceltimer();jsddm_close();ddmenuitem=$(this).find('ul').css('visibility','visible');}
function jsddm_close()
{if(ddmenuitem)ddmenuitem.css('visibility','hidden');}
function jsddm_timer()
{closetimer=window.setTimeout(jsddm_close,timeout);}
function jsddm_canceltimer()
{if(closetimer)
{window.clearTimeout(closetimer);closetimer=null;}}
$(document).ready(function()
{$('#ment > li').bind('mouseover',jsddm_open);$('#ment > li').bind('mouseout',jsddm_timer);});document.onclick=jsddm_close;var autoScroll=(function(){var top;var timer;var actualTop;function startTimer(){timer=setInterval(scroll,40);}
function scroll(){top=document.documentElement.scrollTop||document.body.scrollTop;top++;window.scroll(0,top);actualTop=document.documentElement.scrollTop||document.body.scrollTop;if(top!=actualTop){stopTimer();}}
function stopTimer(){clearInterval(timer);}
return{start:startTimer,stop:stopTimer};})();document.ondblclick=autoScroll.start;document.onmousedown=autoScroll.stop;var setUserSetting=function()
{var bgColor=jQuery.cookie("style_bg_color");var fontSize=jQuery.cookie("style_font_size");var fontFamily=jQuery.cookie("style_font_family");if(bgColor==null)
{bgColor="#e9faff";}
if(fontSize==null)
{fontSize="14px";}
if(fontFamily==null)
{fontFamily="宋体";}
jQuery("body").attr("style_bg_color",bgColor);jQuery("body").attr("style_font_size",fontSize);jQuery("body").attr("style_font_family",fontFamily);jQuery("body").css("background-color",bgColor);jQuery("#readtext p, .listenRead p").css({"font-size":fontSize,"font-family":fontFamily});jQuery("#fontsize1, #fontsize2, #fontsize3, #fontsize4").removeClass("now");jQuery("#fontfamily1, #fontfamily2, #fontfamily3, #fontfamily4").removeClass("now");jQuery("#bgcolor1, #bgcolor2, #bgcolor3, #bgcolor4, #bgcolor5, #bgcolor6").each(function(){var color=jQuery(this).attr("style_bg_color");if(color==bgColor)
{return false;}
return true;});jQuery("#fontsize1, #fontsize2, #fontsize3, #fontsize4").each(function(){var size=jQuery(this).attr("style_font_size");if(size==fontSize)
{jQuery(this).addClass("now");return false;}
return true;});jQuery("#fontfamily1, #fontfamily2, #fontfamily3, #fontfamily4").each(function(){var family=jQuery(this).attr("style_font_family");if(family==fontFamily)
{jQuery(this).addClass("now");return false;}
return true;});jQuery(".watermark").css("background-color",bgColor);};jQuery(function(){jQuery("#bgcolor1, #bgcolor2, #bgcolor3, #bgcolor4, #bgcolor5, #bgcolor6").click(function(){var bgColor=jQuery(this).attr("style_bg_color");jQuery("body").attr("style_bg_color",bgColor);jQuery("body").css("background-color",bgColor);jQuery(".watermark").css("background-color",bgColor);});jQuery("#fontfamily1, #fontfamily2, #fontfamily3, #fontfamily4").click(function(){var fontFamily=jQuery(this).attr("style_font_family");jQuery("body").attr("style_font_family",fontFamily);jQuery("#readtext p, .listenRead p").css("font-family",fontFamily);jQuery("#fontfamily1, #fontfamily2, #fontfamily3, #fontfamily4").removeClass("now");jQuery(this).addClass("now");});jQuery("#fontsize1, #fontsize2, #fontsize3, #fontsize4").click(function(){var fontSize=jQuery(this).attr("style_font_size");jQuery("body").attr("style_font_size",fontSize);jQuery("#readtext p, .listenRead p").css("font-size",fontSize);jQuery("#fontsize1, #fontsize2, #fontsize3, #fontsize4").removeClass("now");jQuery(this).addClass("now");});jQuery("#save_user_setting").click(function(){var bgColor=jQuery("body").attr("style_bg_color");var fontSize=jQuery("body").attr("style_font_size");var fontFamily=jQuery("body").attr("style_font_family");jQuery.cookie("style_bg_color",bgColor,{path:"/",domain:".book.zongheng.com",expires:365});jQuery.cookie("style_font_size",fontSize,{path:"/",domain:".book.zongheng.com",expires:365});jQuery.cookie("style_font_family",fontFamily,{path:"/",domain:".book.zongheng.com",expires:365});alert("保存设置成功 !");});jQuery("#default_user_setting").click(function(){var bgColor="#e9faff";var fontSize="14px";var fontFamily="宋体";jQuery.cookie("style_bg_color",bgColor,{path:"/",domain:".book.zongheng.com",expires:365});jQuery.cookie("style_font_size",fontSize,{path:"/",domain:".book.zongheng.com",expires:365});jQuery.cookie("style_font_family",fontFamily,{path:"/",domain:".book.zongheng.com",expires:365});setUserSetting();alert("恢复设置成功 !");});});