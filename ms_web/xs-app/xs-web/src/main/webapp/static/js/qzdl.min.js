(function($) {
	$.fn
			.extend( {
				qzdlRegService : function() {
					var $form = this;
					var $rand = $form.find("input[name=captcha]");
					var $changeimg = $form.find(".change_img");
					var $username = $form.find("input[name=userName]");

					var $loc = $form.find('input[name=location]');
					var loc = $loc.val();
					if ($.isBlank(loc)) {
						$loc.val(location.href);
					}
					$loc.val(location.href);

					$changeimg.click(function() {
						$form.requestQZDLZCCaptcha(false);
					});
					
					$username.blur(function() {
						var value = this.value;
						var oldval = this.oldval;
						if (!$.isBlank(value) && value != oldval) {
							this.oldval = value;
							$("#qzdlRegImg").attr("src", "http://passport.zongheng.com/registerValidateImage?r="+Math.random());
							$form.find(".randimg").hide().show();
						}
					});
				},
				requestQZDLZCCaptcha : function(checkUser) {
					var $form = this;
					var timer = setInterval(function() {
						if ($.isZhUser === $.curTempUser && checkUser) {
							return;
						} else {
							clearInterval(timer);
							clearTimeout(maxTimeoutTimer);
						}
						
						var imgUrl = "http://passport.zongheng.com/registerValidateImage?r=" + Math.random();
						
						$form.find(".randimg").attr("src", imgUrl).hide()
								.show();
						$form.find("input[name=captcha]").val("");
					}, 100);
					var maxTimeoutTimer = setTimeout(function() {
						clearInterval(timer);
					}, 5000);
				},

				qzdlLoginService : function() {
					var $form = this;
					var $username = $form.find("input[name=username]");
					var $passwd = $form.find("input[name=passwd]");
					var $rand = $form.find("input[name=rand]");
					var $changeimg = $form.find(".change_img");
					$username.blur(function() {
						var value = this.value;
						var oldval = this.oldval;
						if (!$.isBlank(value) && value != oldval) {
							this.oldval = value;
							$form.requestQZDLCaptcha(true);
						}
					});
					$rand.focus(function() {
						if (!$.isBlank($username.val())) {
							if ($.isZhUser === "-") {
								$form.requestQZDLCaptcha(true);
							} else if ($.isZhUser !== $.curTempUser) {
								$form.requestQZDLCaptcha(true);
							}
						}
					});
					$('.qzdl_login').click(loginSubmit);
					$changeimg.click(function() {
						$form.requestQZDLCaptcha(false);
					});
					function loginSubmit() {
						var username = $username.val();
						if (username == '') {
							alert("请输入登录用户名");
							return;
						}
						var passwd = $passwd.val();
						if (passwd == '') {
							alert("请输入密码");
							return;
						}
						var rand = $rand.val();
						if (rand == '') {
							alert("请输入验证码");
							return;
						}
						if ($.isZhUser === "N") {
							var macval = hex_hmac_md5(rand.toLowerCase(),
									str_md5(username + passwd));
							$form.find('input[name=macval]').val(macval);
						}
						var $loc = $form.find('input[name=location]');
						var loc = $loc.val();
						if ($.isBlank(loc)) {
							$loc.val(location.href);
						}
						$form[0].submit();
					}
				},
				requestQZDLCaptcha : function(checkUser) {
					var $form = this;
					var $username = $form.find("input[name=username]");
					var username = $username.val();
					if ($.isBlank(username)) {
						return;
					}
					if (checkUser) {
						$.curTempUser = $.isZhUser;
						$
								.getScript("http://passport.zongheng.com/checkNativeUser.do?userName="
										+ username);
					}
					var timer = setInterval(
							function() {
								if ($.isZhUser === $.curTempUser && checkUser) {
									return;
								} else {
									clearInterval(timer);
									clearTimeout(maxTimeoutTimer);
								}
								var imgUrl = "";
								var actionUrl = "";
								if ($.isZhUser === "N") {
									imgUrl = $.pwVerifyImg + "?r="
											+ Math.random();
									actionUrl = $.pwLogin;
								} else if ($.isZhUser === "E") {
									if (window.confirm("此用户不存在，是否要注册纵横用户？")) {
										window.location = "http://passport.zongheng.com/reg.do?location="
												+ document.location.href;
									} else {
										$username.focus();
										return;
									}
								} else {
									imgUrl = $.zhVerifyImg + "?r="
											+ Math.random();
									actionUrl = $.zhLogin;
								}
								$form.attr("action", actionUrl);
								$form.find(".randimg").attr("src", imgUrl)
										.hide().show();
								$form.find("input[name=rand]").val("");
							}, 100);
					var maxTimeoutTimer = setTimeout(function() {
						clearInterval(timer);
					}, 5000);
				}
			});
	$.extend( {
		zhVerifyImg : "http://passport.zongheng.com/validateImage",
		zhLogin : "http://passport.zongheng.com/signIn.do",
		pwVerifyImg : "http://passport.wanmei.com/servlet/GetRandomImg",
		pwLogin : "http://passport.wanmei.com/accounts/serviceLogin",
		isZhUser : "-",
		curTempUser : "-",
		isBlank : function(s) {
			return s == null || $.trim(s).length == 0 || $.trim(s) == "null";
		}
	});
})(jQuery);