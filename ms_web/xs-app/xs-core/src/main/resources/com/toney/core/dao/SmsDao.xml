<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xiu.portal.dao.SmsDao">
    <resultMap id="smsResult" type="sms">
        <result property="id" column="id" javaType="java.lang.Long" />
        <result property="type" column="type" javaType="java.lang.Integer" />
        <result property="telephone" column="mobile" javaType="java.lang.String" />
        <result property="sendTime" column="SEND_TIME" />
        <result property="lastUpdateTime" column="LAST_UPDATE_TIME" />
        <result property="userId" column="user_id" javaType="java.lang.Long" />
        <result property="body" column="sms_content" javaType="java.lang.String" />
        <result property="activeStatus" column="activeStatus"
            javaType="java.lang.Integer" />
    </resultMap>

    <!-- 插入一个短信发送记录 -->
    <insert id="addSmsRec" parameterType="sms">
        <selectKey keyProperty="id" resultType="java.lang.Long"
            order="BEFORE">
            select X_SMS_RECORD_SEQ.nextval from dual
        </selectKey>
        insert into x_sms_record(id,
        type, mobile, send_time,sms_content,
        last_update_time, user_id, activeStatus)
        values(#{id},
        #{type},
        #{telephone},
        #{sendTime},
        #{body},
        #{lastUpdateTime},
        #{userId},
        #{activeStatus}
        )
    </insert>

    <!-- 根据查询短信记录是否存在 -->
    <select id="findSms" resultMap="smsResult" parameterType="sms">
        <![CDATA[SELECT T.ID, T.SEND_TIME, T.ACTIVESTATUS,T.SMS_CONTENT,T.MOBILE FROM
        X_SMS_RECORD T
        WHERE T.SEND_TIME + 1 > sysdate AND
        T.TYPE=#{type} AND T.MOBILE = #{telephone} ORDER BY T.SEND_TIME
        DESC]]>
    </select>

    <!-- 根据手机号，查询24小时内的短信发送记录数 -->
    <select id="selectSmsCntBySMS" resultType="java.lang.Integer"
        parameterType="sms">
        <![CDATA[SELECT COUNT(*) FROM
        X_SMS_RECORD T WHERE
        T.SEND_TIME + 1 > sysdate AND
        T.TYPE=#{type} AND T.MOBILE
        =#{telephone}]]>
    </select>

    <!-- 更新短信状态 -->
    <update id="updateSmsStatus" parameterType="sms">
        update
        x_sms_record t set t.activeStatus=#{activeStatus} where
        t.id=#{id}
    </update>
</mapper>