<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xiu.portal.dao.EmailDao">
    <resultMap id="emailResult" type="email">
        <result property="id" column="id" javaType="java.lang.Long" />
        <result property="userId" column="user_id" javaType="java.lang.Long" />
        <result property="type" column="email_type" javaType="java.lang.Integer" />
        <result property="activeStatus" column="activeStatus"
            javaType="java.lang.Integer" />
        <result property="receiverMail" column="email_address"
            javaType="java.lang.String" />
        <result property="subject" column="email_topic" javaType="java.lang.String" />
        <result property="body" column="email_content" javaType="java.lang.String" />
        <result property="sendTime" column="send_time" />
        <result property="lastUpdateTime" column="last_update_time" />

    </resultMap>

    <!-- 插入一个邮件发送记录 -->
    <insert id="addEmailRec" parameterType="email">
        <selectKey keyProperty="id" resultType="java.lang.Long"
            order="BEFORE">
            select X_EMAIL_RECORD_SEQ.nextval from dual
        </selectKey>
        insert into x_email_record(id,
        email_type, email_address,
        send_time, email_topic, email_content,
        last_update_time)
        values(#{id},
        #{type},
        #{receiverMail},
        #{sendTime},
        #{subject},
        #{body},
        #{lastUpdateTime}
        )
    </insert>

    <!-- 根据查询邮件记录是否存在 -->
    <select id="findEmail" resultMap="emailResult" parameterType="email">
        <![CDATA[SELECT T.ID, T.SEND_TIME, T.EMAIL_TYPE, T.ACTIVESTATUS, T.EMAIL_ADDRESS FROM
        X_EMAIL_RECORD T
        WHERE T.SEND_TIME + 1 > sysdate AND T.EMAIL_TYPE=#{type}]]>
        <if test="receiverMail!=null">
            AND T.EMAIL_ADDRESS=#{receiverMail}
        </if>
        <if test="userId!=null">
            AND T.USER_ID=#{userId}
        </if>
        <if test="id!=null">
            AND T.ID = #{id}
        </if>
    </select>

    <!-- 根据邮箱号，查询24小时内的邮件发送记录数 -->
    <select id="selectEmailCntByEmailAddress" resultType="java.lang.Integer"
        parameterType="email">
        <![CDATA[SELECT COUNT(*) FROM
        X_EMAIL_RECORD T WHERE
        T.SEND_TIME + 1 > sysdate AND
        T.EMAIL_TYPE=#{type} AND
        T.EMAIL_ADDRESS =#{receiverMail}]]>
    </select>

    <!-- 更新邮件状态 -->
    <update id="updateEmailStatus" parameterType="email">
        update
        x_email_record t set t.ACTIVESTATUS=#{activeStatus} where
        t.id=#{id}
    </update>
</mapper>